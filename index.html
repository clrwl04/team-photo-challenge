<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Photo Challenge</title>
</head>

<body>
  <h1>Team Photo Challenge</h1>

  <label>Team Name:</label>
  <input id="teamName" type="text" />

  <br><br>

  <label>Take Photo:</label>
  <input id="photoInput" type="file" accept="image/*" capture="environment" />

  <br><br>

  <button id="submitBtn">Submit</button>

  <script type="module">
    /* ---------------------------------------------------------
       1. Firebase Initialization (Verified)
    --------------------------------------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
    import { getDatabase, ref, push, set }
      from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getDatabase(app);

    /* ---------------------------------------------------------
       2. Helper: Get GPS Location
    --------------------------------------------------------- */
    function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          }),
          err => reject(err)
        );
      });
    }

    /* ---------------------------------------------------------
       3. Helper: Upload Photo to Firebase Storage
    --------------------------------------------------------- */
    async function uploadPhoto(file, teamName) {
      const filePath = `photos/${teamName}/${Date.now()}.jpg`;
      const fileRef = storageRef(storage, filePath);

      await uploadBytes(fileRef, file);
      return await getDownloadURL(fileRef);
    }

    /* ---------------------------------------------------------
       4. Save Submission to Realtime Database
    --------------------------------------------------------- */
    async function saveSubmissionToFirebase({ teamName, photoUrl, latitude, longitude }) {
      const teamRef = ref(db, `submissions/${teamName}`);
      const newEntry = push(teamRef);

      await set(newEntry, {
        teamName,
        photoUrl,
        latitude,
        longitude,
        timestamp: Date.now()
      });
    }

    /* ---------------------------------------------------------
       5. Main Submit Handler
    --------------------------------------------------------- */
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const teamName = document.getElementById("teamName").value.trim();
      const file = document.getElementById("photoInput").files[0];

      if (!teamName || !file) {
        alert("Please enter a team name and take a photo.");
        return;
      }

      try {
        const { latitude, longitude } = await getLocation();
        const photoUrl = await uploadPhoto(file, teamName);

        await saveSubmissionToFirebase({
          teamName,
          photoUrl,
          latitude,
          longitude
        });

        alert("Submission saved successfully!");
      } catch (err) {
        console.error(err);
        alert("Something went wrong.");
      }
    });
  </script>
</body>
</html>
