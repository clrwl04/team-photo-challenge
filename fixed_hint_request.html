<!DOCTYPE html>
<html lang="en">
<!-- version: 2026-02-08-3 -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hint Request</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    #loading {
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: none;
    }
    #error {
      color: red;
      font-weight: bold;
      display: none;
    }
    #hint {
      background: white;
      padding: 20px;
      border-radius: 8px;
      display: none;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>

  <div id="loading">Loading hint…</div>
  <div id="error"></div>
  <div id="hint"></div>

  <script type="module">
    /* ------------------------------
       Firebase Imports (same as index.html)
    ------------------------------ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js?v=3";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js?v=3";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js?v=3";

    /* ------------------------------
       Firebase Config (same as index.html)
    ------------------------------ */
    const firebaseConfig = {
      apiKey: "AIzaSyC2u62B4yUyLJmLH1IdI8tJEp6iHruPH0A",
      authDomain: "team-photo-challenge.firebaseapp.com",
      projectId: "team-photo-challenge",
      storageBucket: "team-photo-challenge.firebasestorage.app",
      messagingSenderId: "818498843878",
      appId: "1:818498843878:web:c94a7e2f46798277c9f727",
      databaseURL: "https://team-photo-challenge-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const functions = getFunctions(app);
    const requestHintFn = httpsCallable(functions, "requestHint");

    /* ------------------------------
       UI Helpers
    ------------------------------ */
    function showLoading() {
      document.getElementById("loading").style.display = "block";
      document.getElementById("error").style.display = "none";
      document.getElementById("hint").style.display = "none";
    }

    function showError(msg) {
      document.getElementById("loading").style.display = "none";
      const el = document.getElementById("error");
      el.textContent = msg;
      el.style.display = "block";
    }

    function showHint(text) {
      document.getElementById("loading").style.display = "none";
      const el = document.getElementById("hint");
      el.textContent = text;
      el.style.display = "block";
    }

    /* ------------------------------
       Parse URL Parameters
    ------------------------------ */
    function getParams() {
      const url = new URL(window.location.href);
      return {
        tokenId: url.searchParams.get("tokenId"),
        locationId: url.searchParams.get("locationId"),
        hintId: url.searchParams.get("hintId")
      };
    }

    /* ------------------------------
       Validate Token in Realtime DB
    ------------------------------ */
    async function validateToken(tokenId) {
      const tokenRef = ref(db, `requesterTokens/${tokenId}`);
      const snap = await get(tokenRef);
      return snap.exists() ? snap.val() : null;
    }

    /* ------------------------------
       Main Hint Request Logic
    ------------------------------ */
    async function requestHint() {
      showLoading();

      try {
        const params = getParams();
        if (!params.tokenId || !params.locationId || !params.hintId) {
          showError("Missing required parameters.");
          return;
        }

        // Validate requester token
        const tokenData = await validateToken(params.tokenId);
        if (!tokenData || tokenData.enabled !== true || tokenData.role !== "requester") {
          showError("Invalid or disabled token.");
          return;
        }

        // Call Cloud Function (NO App Check)
        const response = await requestHintFn({
          tokenId: params.tokenId,
          locationId: params.locationId,
          hintId: params.hintId
        });

        // Success — show the hint
        showHint(response.data.value);


      } catch (err) {
        console.error(err);
        showError("Unexpected error.");
      }
    }

    /* ------------------------------
       Start on Load
    ------------------------------ */
    window.addEventListener("DOMContentLoaded", requestHint);
  </script>

</body>
</html>
