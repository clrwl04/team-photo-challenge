<!DOCTYPE html>
<html lang="en">
<!-- version: 2026-02-08-8 -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hint Request</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    #loading {
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: none;
    }
    #error {
      color: red;
      font-weight: bold;
      display: none;
    }
    #hint {
      background: white;
      padding: 20px;
      border-radius: 8px;
      display: none;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>

  <div id="loading">Loading hintâ€¦</div>
  <div id="error"></div>
  <div id="hint"></div>

  <!--<script src="firebase-init.js"></script>-->

  <script type="module">
  /* ------------------------------
     Firebase Imports (aligned with working page)
  ------------------------------ */
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

  /* ------------------------------
     Firebase Config (same as working page)
  ------------------------------ */
  const firebaseConfig = {
    apiKey: "AIzaSyC2u62B4yUyLJmLH1IdI8tJEp6iHruPH0A",
    authDomain: "team-photo-challenge.firebaseapp.com",
    projectId: "team-photo-challenge",
    storageBucket: "team-photo-challenge.firebasestorage.app",
    messagingSenderId: "818498843878",
    appId: "1:818498843878:web:c94a7e2f46798277c9f727",
    databaseURL: "https://team-photo-challenge-default-rtdb.firebaseio.com/"
  };

  /* ------------------------------
     Firebase Initialization (MATCHES WORKING PAGE)
     - Delayed
     - Protected from extensions
     - Protected from double init
  ------------------------------ */
  async function initFirebase() {
    let app;

    // Prevent extension interference or double initialization
    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
    } else {
      app = getApp();
    }

    const db = getDatabase(app);
    const functions = getFunctions(app);

    return { app, db, functions };
  }

  /* ------------------------------
     UI Helpers
  ------------------------------ */
  function showLoading() {
    document.getElementById("loading").style.display = "block";
    document.getElementById("error").style.display = "none";
    document.getElementById("hint").style.display = "none";
  }

  function showError(msg) {
    document.getElementById("loading").style.display = "none";
    const el = document.getElementById("error");
    el.textContent = msg;
    el.style.display = "block";
  }

  function showHint(text) {
    document.getElementById("loading").style.display = "none";
    const el = document.getElementById("hint");
    el.textContent = text;
    el.style.display = "block";
  }

  /* ------------------------------
     Parse URL Parameters
  ------------------------------ */
  function getParams() {
    const url = new URL(window.location.href);
    return {
      tokenId: url.searchParams.get("tokenId"),
      locationId: url.searchParams.get("locationId"),
      hintId: url.searchParams.get("hintId")
    };
  }

  /* ------------------------------
     Validate Token in Realtime DB
  ------------------------------ */
  async function validateToken(db, tokenId) {
    const tokenRef = ref(db, `requesterTokens/${tokenId}`);
    const snap = await get(tokenRef);
    return snap.exists() ? snap.val() : null;
  }

  /* ------------------------------
     Main Hint Request Logic
  ------------------------------ */
  async function requestHint() {
    showLoading();

    try {
      const { db, functions } = await initFirebase();

      const params = getParams();
      if (!params.tokenId || !params.locationId || !params.hintId) {
        showError("Missing required parameters.");
        return;
      }

      // Validate requester token
      const tokenData = await validateToken(db, params.tokenId);
      if (!tokenData || tokenData.enabled !== true || tokenData.role !== "requester") {
        showError("Invalid or disabled token.");
        return;
      }

      // Callable function (now works)
      const requestHintFn = httpsCallable(functions, "requestHint");
      const response = await requestHintFn({
        tokenId: params.tokenId,
        locationId: params.locationId,
        hintId: params.hintId
      });

      showHint(response.data.value);

    } catch (err) {
      console.error(err);
      showError("Unexpected error.");
    }
  }

  /* ------------------------------
     Start on Load (matches working page timing)
  ------------------------------ */
  window.addEventListener("DOMContentLoaded", requestHint);
</script>


</body>
</html>
