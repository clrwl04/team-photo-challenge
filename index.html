<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Photo Submission</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .team-badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            font-size: 18px;
            margin: 10px 0;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .camera-section {
            margin: 20px 0;
        }

        #videoElement {
            width: 100%;
            border-radius: 10px;
            background: #000;
            display: none;
        }

        #canvas {
            display: none;
        }

        .preview-container {
            margin-bottom: 20px;
        }

        #preview {
            width: 100%;
            border-radius: 10px;
            display: none;
        }

        .location-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .location-info h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .location-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .button-secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .button-success {
            background: #4CAF50;
            color: white;
        }

        .button-success:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            display: block;
        }

        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .result-modal.show {
            display: flex;
        }

        .result-content {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .result-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }

        .result-message {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 25px;
            white-space: pre-line;
        }

        .result-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-button.success {
            background: #4CAF50;
            color: white;
        }

        .result-button.success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .result-button.error {
            background: #f44336;
            color: white;
        }

        .result-button.error:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Team Photo Challenge</h1>
            <div class="team-badge" id="teamBadge">Initializing...</div>
            <p class="subtitle">Capture and submit photos with location</p>
        </div>

        <div class="status" id="status"></div>
        <div class="spinner" id="spinner"></div>

        <div class="camera-section">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div class="preview-container">
                <img id="preview" alt="Captured photo">
            </div>
        </div>

        <div class="location-info" id="locationInfo">
            <h3>üìç Location Captured</h3>
            <p id="coordinates"></p>
            <p id="timestamp"></p>
        </div>

        <button id="captureBtn" class="button button-primary" style="display: none;">üì∑ Start Camera</button>
        <button id="retakeBtn" class="button button-secondary" style="display: none;">üîÑ Retake Photo</button>
        <button id="submitBtn" class="button button-success" style="display: none;">‚úÖ Submit Photo</button>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="result-modal">
        <div class="result-content">
            <div id="resultIcon" class="result-icon"></div>
            <div id="resultTitle" class="result-title"></div>
            <div id="resultMessage" class="result-message"></div>
            <button id="resultButton" class="result-button"></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getDatabase, ref as dbRef, get, push, set, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // CONFIGURATION - Replace with your values
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyC2u62B4yUyLJmLH1IdI8tJEp6iHruPH0A",
                authDomain: "team-photo-challenge.firebaseapp.com",
                projectId: "team-photo-challenge",
                storageBucket: "team-photo-challenge.firebasestorage.app",
                messagingSenderId: "818498843878",
                appId: "1:818498843878:web:c94a7e2f46798277c9f727",
                databaseURL: "https://team-photo-challenge-default-rtdb.firebaseio.com/"
            }
        };

        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('preview');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');
        const locationInfo = document.getElementById('locationInfo');
        const spinner = document.getElementById('spinner');
        const teamBadge = document.getElementById('teamBadge');
        const resultModal = document.getElementById('resultModal');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultMessage = document.getElementById('resultMessage');
        const resultButton = document.getElementById('resultButton');

        let stream = null;
        let app = null;
        let storage = null;
        let database = null;
        let currentTeam = null;
        let currentToken = null;
        let locationPermissionGranted = false;

        let capturedData = {
            photoBlob: null,
            latitude: null,
            longitude: null,
            timestamp: null
        };

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        function showSpinner(show) {
            spinner.style.display = show ? 'block' : 'none';
        }

        function showResultModal(success, title, message) {
            resultModal.classList.add('show');
            resultIcon.textContent = success ? 'üéâ' : '‚ùå';
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            resultButton.textContent = success ? 'Take Another Photo' : 'Try Again';
            resultButton.className = `result-button ${success ? 'success' : 'error'}`;
            
            // Hide spinner and status when showing modal
            showSpinner(false);
            status.style.display = 'none';
        }

        function hideResultModal() {
            resultModal.classList.remove('show');
            retake();
        }

        async function requestLocationPermission() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(false);
                    return;
                }

                showStatus('Requesting location permission...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    () => {
                        locationPermissionGranted = true;
                        showStatus('Location permission granted ‚úì', 'success');
                        resolve(true);
                    },
                    (error) => {
                        locationPermissionGranted = false;
                        showStatus('Location permission denied. You must allow location access to submit photos.', 'error');
                        resolve(false);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        async function initFirebase() {
            try {
                app = initializeApp(CONFIG.firebase);
                storage = getStorage(app);
                database = getDatabase(app);
                return true;
            } catch (err) {
                showStatus(`Firebase initialization failed: ${err.message}`, 'error');
                return false;
            }
        }

        async function validateToken(token) {
            try {
                showSpinner(true);
                showStatus('Validating access token...', 'info');
                console.log('Validating token:', token);
                console.log('Database URL:', CONFIG.firebase.databaseURL);
                
                const tokenRef = dbRef(database, `tokens/${token}`);
                console.log('Token ref path:', `tokens/${token}`);
                
                const snapshot = await get(tokenRef);
                console.log('Token snapshot exists:', snapshot.exists());
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Token data:', data);
                    
                    if (data.enabled !== false) {
                        showSpinner(false);
                        console.log('Token valid, team name:', data.teamName);
                        return data.teamName;
                    } else {
                        console.log('Token is disabled');
                    }
                } else {
                    console.log('Token does not exist in database');
                }
                
                showSpinner(false);
                return null;
            } catch (err) {
                showSpinner(false);
                console.error('Token validation error:', err);
                console.error('Error details:', err.message, err.code);
                showStatus(`Validation error: ${err.message}`, 'error');
                return null;
            }
        }

        async function initApp() {
            try {
                teamBadge.textContent = 'Checking token...';
                
                const urlParams = new URLSearchParams(window.location.search);
                currentToken = urlParams.get('token');
                
                if (!currentToken) {
                    teamBadge.textContent = '‚ùå No Token';
                    teamBadge.style.background = '#f44336';
                    showStatus('No access token provided. Please scan a valid QR code.', 'error');
                    console.error('No token in URL');
                    return;
                }
                
                console.log('Token found:', currentToken);
                teamBadge.textContent = 'Connecting to Firebase...';
                
                const initialized = await initFirebase();
                if (!initialized) {
                    teamBadge.textContent = '‚ùå Firebase Error';
                    teamBadge.style.background = '#f44336';
                    console.error('Firebase initialization failed');
                    return;
                }
                
                console.log('Firebase initialized successfully');
                teamBadge.textContent = 'Validating token...';
                
                currentTeam = await validateToken(currentToken);
                
                if (!currentTeam) {
                    teamBadge.textContent = '‚ùå Invalid Token';
                    teamBadge.style.background = '#f44336';
                    showStatus('Invalid or disabled token. Please contact the event organizer.', 'error');
                    console.error('Token validation failed');
                    return;
                }
                
                console.log('Team validated:', currentTeam);
                teamBadge.textContent = `üéØ ${currentTeam}`;
                
                // Request location permission immediately
                const locationGranted = await requestLocationPermission();
                
                if (locationGranted) {
                    captureBtn.style.display = 'block';
                    showStatus(`Welcome, ${currentTeam}! Ready to capture photos.`, 'success');
                    console.log('Location permission granted');
                } else {
                    showStatus('Location access is required. Please enable location permissions and reload the page.', 'error');
                    console.error('Location permission denied');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                teamBadge.textContent = '‚ùå Error';
                teamBadge.style.background = '#f44336';
                showStatus(`Initialization error: ${error.message}`, 'error');
            }
        }

        async function startCamera() {
            try {
                showSpinner(true);
                showStatus('Requesting camera access...', 'info');
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                captureBtn.textContent = 'üì∏ Capture Photo';
                showStatus('Camera ready! Position your shot and click Capture.', 'success');
                showSpinner(false);
            } catch (err) {
                showSpinner(false);
                let errorMsg = 'Camera access error: ';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'Permission denied. Please allow camera access in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'No camera found on this device.';
                } else if (err.name === 'NotReadableError') {
                    errorMsg += 'Camera is being used by another app.';
                } else {
                    errorMsg += err.message;
                }
                
                showStatus(errorMsg, 'error');
            }
        }

        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        reject(new Error(`Location error: ${error.message}`));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        async function capturePhoto() {
            if (!stream) {
                await startCamera();
                return;
            }

            try {
                showSpinner(true);
                showStatus('Getting current location...', 'info');

                const location = await getLocation();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const base64Data = dataUrl.split(',')[1];
                const byteString = atob(base64Data);
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                capturedData.photoBlob = new Blob([ab], { type: 'image/jpeg' });
                
                capturedData.latitude = location.latitude;
                capturedData.longitude = location.longitude;
                capturedData.timestamp = new Date().toISOString();

                stream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                stream = null;

                preview.src = dataUrl;
                preview.style.display = 'block';

                document.getElementById('coordinates').textContent = 
                    `Lat: ${location.latitude.toFixed(6)}, Lng: ${location.longitude.toFixed(6)}`;
                document.getElementById('timestamp').textContent = 
                    `Time: ${new Date(capturedData.timestamp).toLocaleString()}`;
                locationInfo.style.display = 'block';

                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                submitBtn.style.display = 'block';

                showStatus('Photo and location captured! Review and submit.', 'success');
                showSpinner(false);

            } catch (err) {
                showSpinner(false);
                showStatus(`Error: ${err.message}`, 'error');
            }
        }

        function retake() {
            preview.style.display = 'none';
            locationInfo.style.display = 'none';
            retakeBtn.style.display = 'none';
            submitBtn.style.display = 'none';
            captureBtn.style.display = 'block';
            captureBtn.textContent = 'üì∑ Start Camera';
            capturedData = {
                photoBlob: null,
                latitude: null,
                longitude: null,
                timestamp: null
            };
        }

        async function uploadToFirebase() {
            const filename = `${currentTeam.replace(/\s+/g, '_')}_${Date.now()}.jpg`;
            const photoRef = storageRef(storage, `photos/${filename}`);
            
            await uploadBytes(photoRef, capturedData.photoBlob);
            const downloadURL = await getDownloadURL(photoRef);
            
            return downloadURL;
        }

        async function saveSubmissionToDatabase(photoUrl) {
            const submissionData = {
                teamName: currentTeam,
                photoUrl: photoUrl,
                latitude: capturedData.latitude,
                longitude: capturedData.longitude,
                timestamp: capturedData.timestamp
            };

            const submissionsRef = dbRef(database, 'submissions');
            const newSubmissionRef = push(submissionsRef);
            await set(newSubmissionRef, submissionData);
            
            return newSubmissionRef.key;
        }

        async function handleSubmit() {
            try {
                showSpinner(true);
                showStatus('Uploading photo to Firebase Storage...', 'info');

                const photoUrl = await uploadToFirebase();
                
                showStatus('Saving submission to database...', 'info');
                const submissionId = await saveSubmissionToDatabase(photoUrl);

                showStatus(`‚úÖ Successfully submitted for ${currentTeam}! (ID: ${submissionId})`, 'success');
                showSpinner(false);

                setTimeout(() => {
                    retake();
                }, 3000);

            } catch (err) {
                showSpinner(false);
                showStatus(`Submission error: ${err.message}`, 'error');
            }
        }

        captureBtn.addEventListener('click', capturePhoto);
        retakeBtn.addEventListener('click', retake);
        submitBtn.addEventListener('click', handleSubmit);
        resultButton.addEventListener('click', hideResultModal);

        initApp();
    </script>
</body>
</html>
